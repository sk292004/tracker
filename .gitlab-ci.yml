stages:
  - build
  - test      # New stage for SonarQube
  - deploy
  - security  # New stage for OWASP ZAP

variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  # Replace these with the keys SonarCloud gave you in Part 1
  SONAR_PROJECT_KEY: "your_project_key_from_sonarcloud"
  SONAR_ORG_KEY: "your_org_key_from_sonarcloud"

# 1. Build App
build_image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG

# 2. Code Quality Scan (SonarQube)
sonar_scan:
  stage: test
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  script:
    - sonar-scanner -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.organization=$SONAR_ORG_KEY -Dsonar.sources=. -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN

# 3. Deploy to EC2
deploy_to_ec2:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $EC2_IP_ADDRESS >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to $EC2_IP_ADDRESS..."
    - ssh ubuntu@$EC2_IP_ADDRESS "
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker pull $IMAGE_TAG &&
        docker stop tracker-app || true &&
        docker rm tracker-app || true &&
        docker run -d -p 3000:3000 --name tracker-app $IMAGE_TAG"

# 4. Security Scan (OWASP ZAP)
zap_scan:
  stage: security
  image: owasp/zap2docker-stable
  script:
    # This scans your running EC2 website for vulnerabilities
    - zap-baseline.py -t http://$EC2_IP_ADDRESS:3000 -r zap_report.html || true
  artifacts:
    when: always
    paths:
      - zap_report.html
